## Example Woodpecker CI pipeline for multi-service deployment
## using the d-rymcg-tech workstation Docker image with OpenBao.
##
## The d-rymcg-tech entrypoint handles all auth, decryption, and SSH
## setup automatically when the BAO_* env vars are provided.
##
## Required Woodpecker secrets:
##   BAO_ADDR          - OpenBao server URL
##   BAO_ROLE_ID       - AppRole role ID
##   BAO_SECRET_ID     - AppRole secret ID
##   BAO_AGE_KEY_PATH  - KV path to AGE key (e.g., sops/d2-admin/myserver-production)
##   BAO_CACERT        - CA cert for OpenBao TLS (if using private CA)
##
## Optional Woodpecker secrets:
##   BAO_CLIENT_CERT - mTLS client cert (if OpenBao uses mTLS)
##   BAO_CLIENT_KEY  - mTLS client key  (if OpenBao uses mTLS)
##   BAO_NAMESPACE   - OpenBao namespace (if using namespaces)
##
## Required files in repo:
##   config/my-server.sops.env - SOPS-encrypted env export
##     (created with: d export-env --encrypt > config/my-server.sops.env)

steps:
  - name: deploy-traefik
    image: d-rymcg-tech
    secrets: [bao_addr, bao_role_id, bao_secret_id, bao_age_key_path, bao_cacert]
    environment:
      SOPS_CONFIG_FILE: ${CI_WORKSPACE}/config/my-server.sops.env
    commands:
      - d.rymcg.tech make traefik install

  - name: deploy-whoami
    image: d-rymcg-tech
    secrets: [bao_addr, bao_role_id, bao_secret_id, bao_age_key_path, bao_cacert]
    environment:
      SOPS_CONFIG_FILE: ${CI_WORKSPACE}/config/my-server.sops.env
    commands:
      - d.rymcg.tech make whoami install

  - name: verify
    image: d-rymcg-tech
    secrets: [bao_addr, bao_role_id, bao_secret_id, bao_age_key_path, bao_cacert]
    environment:
      SOPS_CONFIG_FILE: ${CI_WORKSPACE}/config/my-server.sops.env
    commands:
      - d.rymcg.tech make whoami wait
      - echo "Deployed to https://$(d make whoami dotenv_get var=WHOAMI_TRAEFIK_HOST)"

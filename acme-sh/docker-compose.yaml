services:
  ## Build a base image from upstream git repository:
  base-image:
    image: local/acme-sh-base-image:${ACME_SH_GIT_TAG}
    build:
      context: ${ACME_SH_GIT_REPO}.git#${ACME_SH_GIT_TAG}
      args:
        AUTO_UPGRADE: ${ACME_SH_AUTO_UPGRADE}
    ## Prevent the base image from running:
    profiles: ['build-only']
    entrypoint: ["/bin/false"]
    command: []

  ## Build cron image from the base, which includes our customizations:
  cron:
    build:
      context: cron
      args:
        GIT_TAG: ${ACME_SH_GIT_TAG}
        CRON_SCHEDULE: ${ACME_SH_CRON_SCHEDULE}
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    command: daemon
    network_mode: host
    volumes:
      - "private:/acme.sh"
      - "certs:/certs"
    # All labels are defined in the template: docker-compose.instance.yaml
    labels: []

volumes:
  private:
  certs:

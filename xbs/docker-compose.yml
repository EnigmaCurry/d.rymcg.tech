version: "3.7"

networks:
  traefik-proxy:
    external:
      name: traefik-proxy

services:
  db:
    container_name: "xbs-db"
    environment:
      - "MONGO_INITDB_DATABASE=$DB_NAME"
      - "MONGO_INITDB_ROOT_PASSWORD=$DB_PASSWORD"
      - "MONGO_INITDB_ROOT_USERNAME=$DB_USERNAME"
      - "XBS_DB_NAME=$DB_NAME"
      - "XBS_DB_PASSWORD=$DB_PASSWORD"
      - "XBS_DB_USERNAME=$DB_USERNAME"
    build: ./db
    restart: "unless-stopped"
    volumes:
      - "xbs-db-data:/data/db"
      - "xbs-db-backups:/data/backups"

  api:
    container_name: "xbs-api"
    build: ./api
    depends_on:
      - "db"
    environment:
      - "XBROWSERSYNC_DB_PWD=$DB_PASSWORD"
      - "XBROWSERSYNC_DB_USER=$DB_USERNAME"
    healthcheck:
      test: [ "CMD", "node", "/usr/src/api/healthcheck.js" ]
      interval: "1m"
      timeout: "10s"
      retries: "5"
      start_period: "30s"
    restart: "unless-stopped"
    networks:
      - default
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.xbs.rule=Host(`${XBS_TRAEFIK_HOST}`)"
      - "traefik.http.routers.xbs.entrypoints=websecure"
      - "traefik.http.routers.xbs.tls.certresolver=${ACME_CERT_RESOLVER}"
      - "traefik.http.services.xbs.loadbalancer.server.port=8080"

volumes:
  xbs-db-backups:
  xbs-db-data:
#!/bin/bash
# Create a new random password, but only if its not set already.
# Stores bcrypt hash in ENV_FILE under PASSWORD_VAR.
# reconfigure_password_bcrypt ENV_FILE VAR [LENGTH]

BIN=$(dirname "${BASH_SOURCE[0]}")
source "${BIN}/funcs.sh"
set -euo pipefail

ENV_FILE="${1}"
PASSWORD_VAR="${2}"
LENGTH="${3:-35}"
check_var ENV_FILE PASSWORD_VAR
check_num LENGTH

if ! [[ -f "${ENV_FILE}" ]]; then
    fault "Environment file not found: ${ENV_FILE}"
fi

if ! command -v htpasswd >/dev/null 2>&1; then
    fault "Missing 'htpasswd' (bcrypt). Install apache2-utils / httpd-tools / apache."
fi

CURRENT="$("${BIN}/dotenv" -f "${ENV_FILE}" get "${PASSWORD_VAR}")"
if [[ -z "${CURRENT}" ]]; then
    PASSWORD="$(gen_password "${LENGTH}")"

    # htpasswd outputs "user:hash"
    HASH="$(htpasswd -nbB "__user__" "${PASSWORD}" | cut -d: -f2)"

    # Escape for docker-compose .env (turn $ into $$)
    HASH_ENV="$(printf '%s' "$HASH" | sed 's/\$/$$/g')"
    
    "${BIN}/reconfigure" "${ENV_FILE}" "${PASSWORD_VAR}=${HASH_ENV}"

    echo "# Generated new password for ${PASSWORD_VAR} (record this now): ${PASSWORD}" >&2
    unset PASSWORD HASH HASH_ENV
else
    echo "# Using existing value for ${PASSWORD_VAR}"
fi

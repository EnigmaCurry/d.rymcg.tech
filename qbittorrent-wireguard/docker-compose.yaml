volumes:
  wireguard:
  qbittorrent-config:

services:
  wireguard-config:
    build:
      context: wireguard-config
    environment:
      - QBITTORRENT_VPN_CLIENT_INTERFACE_PRIVATE_KEY
      - QBITTORRENT_VPN_CLIENT_INTERFACE_IPV4
      - QBITTORRENT_VPN_CLIENT_INTERFACE_IPV6
      - QBITTORRENT_VPN_CLIENT_INTERFACE_LISTEN_PORT
      - QBITTORRENT_VPN_CLIENT_INTERFACE_PEER_DNS
      - QBITTORRENT_VPN_CLIENT_PEER_PUBLIC_KEY
      - QBITTORRENT_VPN_CLIENT_PEER_ALLOWED_IPS
      - QBITTORRENT_VPN_CLIENT_PEER_ENDPOINT
    volumes:
      - wireguard:/config

  wireguard:
    depends_on: ['wireguard-config']
    image: linuxserver/wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - wireguard:/config
      - /lib/modules:/lib/modules
    restart: always
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qbittorrent-${QBITTORRENT_INSTANCE:-default}.rule=Host(`${QBITTORRENT_TRAEFIK_HOST}`)"
      - "traefik.http.routers.qbittorrent-${QBITTORRENT_INSTANCE:-default}.entrypoints=websecure"
      - "traefik.http.services.qbittorrent-${QBITTORRENT_INSTANCE:-default}.loadBalancer.server.port=8080"
      ## Authentication:
      - "traefik.http.middlewares.qbittorrent-${QBITTORRENT_INSTANCE:-default}-auth.basicauth.users=${QBITTORRENT_HTTP_AUTH}"
      - "traefik.http.middlewares.qbittorrent-${QBITTORRENT_INSTANCE:-default}-ipwhitelist.ipwhitelist.sourcerange=${QBITTORRENT_IP_SOURCERANGE}"
      - "traefik.http.routers.qbittorrent-${QBITTORRENT_INSTANCE:-default}.middlewares=qbittorrent-${QBITTORRENT_INSTANCE:-default}-ipwhitelist,qbittorrent-${QBITTORRENT_INSTANCE:-default}-auth"
      ## Homepage labels for auto-discovery and config:
      - "homepage.group=Group A"
      - "homepage.name=qBittorrent"
      - "homepage.icon=qbittorrent.png"
      - "homepage.href=http://${QBITTORRENT_TRAEFIK_HOST}"
      - "homepage.description=qBittorrent client in a Wireguard VPN"
      - "homepage.widget.type=qbittorrent"
      - "homepage.widget.url=http://${QBITTORRENT_TRAEFIK_HOST}"
      - "homepage.widget.username="
      - "homepage.widget.password="
      - "homepage.widget.fields=[\"leech\", \"download\", \"seed\", "upload\"]"

  qbittorrent-config:
    build:
      context: qbittorrent-config
    environment:
      - QBITTORRENT_TRAEFIK_HOST
      - QBITTORRENT_VPN_CLIENT_INTERFACE_IPV4
      - QBITTORRENT_VPN_CLIENT_INTERFACE_IPV6
      - QBITTORRENT_RPC_BIND_ADDRESS
      - QBITTORRENT_BLOCKLIST_URL
      - QBITTORRENT_PEER_PORT
      - QBITTORRENT_OnTorrentAddedEnabled
      - QBITTORRENT_OnTorrentAddedProgram
      - QBITTORRENT_enabled
      - QBITTORRENT_program
      - QBITTORRENT_SessionAddExtensionToIncompleteFiles
      - QBITTORRENT_SessionAlternativeGlobalDLSpeedLimit
      - QBITTORRENT_SessionAlternativeGlobalUPSpeedLimit
      - QBITTORRENT_SessionDefaultSavePath
      - QBITTORRENT_SessionDisableAutoTMMByDefault
      - QBITTORRENT_SessionDisableAutoTMMTriggersCategorySavePathChanged
      - QBITTORRENT_SessionDisableAutoTMMTriggersDefaultSavePathChanged
      - QBITTORRENT_SessionExcludedFileNames
      - QBITTORRENT_SessionIgnoreSlowTorrentsForQueueing
      - QBITTORRENT_SessionMaxActiveDownloads
      - QBITTORRENT_SessionMaxActiveTorrents
      - QBITTORRENT_SessionMaxActiveUploads
      - QBITTORRENT_SessionTempPath
      - QBITTORRENT_SessionTempPathEnabled
      - QBITTORRENT_SessionQueueingSystemEnabled
      - QBITTORRENT_SessionTorrentExportDirectory
      - QBITTORRENT_AutoDeleteAddedTorrentFile
      - QBITTORRENT_DownloadsSavePath
      - QBITTORRENT_DownloadsTempPath
      - QBITTORRENT_SessionTorrentContentLayout
      - QBITTORRENT_GeneralLocale
      - QBITTORRENT_MailNotificationemail
      - QBITTORRENT_MailNotificationenabled
      - QBITTORRENT_MailNotificationpassword
      - QBITTORRENT_MailNotificationreq_auth
      - QBITTORRENT_MailNotificationreq_ssl
      - QBITTORRENT_MailNotificationsender
      - QBITTORRENT_MailNotificationsmtp_server
      - QBITTORRENT_MailNotificationusername
      - QBITTORRENT_WebUICustomHTTPHeaders
      - QBITTORRENT_WebUICustomHTTPHeadersEnabled
      - QBITTORRENT_WebUIHostHeaderValidation
      - QBITTORRENT_WebUILocalHostAuth
      - QBITTORRENT_WebUIReverseProxySupportEnabled
      - QBITTORRENT_WebUITrustedReverseProxiesList
      - QBITTORRENT_Schedulerdays
      - QBITTORRENT_Schedulerend_time
      - QBITTORRENT_Schedulerstart_time
      - QBITTORRENT_SessionUseAlternativeGlobalSpeedLimit
      - QBITTORRENT_SessionBandwidthSchedulerEnabled
      - QBITTORRENT_WebUIPassword_PBKDF2
      - QBITTORRENT_WebUIServerDomains
      - QBITTORRENT_WebUIUsername
      - QBITTORRENT_WebUIAuthSubnetWhitelistEnabled
      - QBITTORRENT_WebUIAuthSubnetWhitelist
    volumes:
      - qbittorrent-config:/config

  qbittorrent:
    image: linuxserver/qbittorrent:${QBITTORRENT_VERSION}
    network_mode: "service:wireguard"
    depends_on:
      - wireguard
      - qbittorrent-config
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
      - WEBUI_PORT=8080
    volumes:
      - qbittorrent-config:/config
      - type: bind
        source: ${QBITTORRENT_DOWNLOAD_VOLUME}
        target: /downloads
    restart: always

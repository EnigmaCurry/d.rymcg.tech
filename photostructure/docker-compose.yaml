version: '3.0'

networks:
  traefik-proxy:
    external:
      name: traefik-proxy

volumes:
  psconfig:
  pslib:
  pslog:
  pstmp:
    
services:
  photostructure:
    image: photostructure/server:alpha
    container_name: photostructure
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      - PS_SCAN_ALL_DRIVES
      - PS_SCAN_MY_PICTURES
      - PS_SCAN_PATHS
      - PS_LOG_LEVEL
      - PS_LOG_COMPRESS
      - PS_REQUIRE_MAKE_MODEL
      - PS_SYNC_INTERVAL_HOURS
      - PS_FIX_PERMISSIONS
      - UID
      - GID
      - PS_CPU_LOAD_PERCENT
      - PS_PROCESS_PRIORITY
      - PS_ORIGINALS_DIR
    volumes:
      - psconfig:/ps/config:rw
      - pslib:/ps/library:rw
      - pslog:/ps/logs:rw
      - pstmp:/ps/tmp:rw
      - ${ASSET_DIR_HOST}:${ASSET_DIR_CONTAINER}:rw
    networks:
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.photostructure.entrypoints=websecure"
      - "traefik.http.routers.photostructure.rule=Host(`${PHOTOSTRUCTURE_TRAEFIK_HOST}`)"
      - "traefik.http.routers.photostructure.tls=true"
      - "traefik.http.routers.photostructure.tls.certresolver=default"
      - "traefik.http.routers.photostructure.service=photostructure"
      - "traefik.http.services.photostructure.loadbalancer.server.port=1787"
      - "traefik.http.middlewares.photostructure-auth.basicauth.users=${BASICAUTH_USERS}"
      - "traefik.http.routers.photostructure-secure.middlewares=photostructure-auth"
version: '3.0'

networks:
  traefik-proxy:
    external:
      name: traefik-proxy

services:
  photostructure:
    image: photostructure/server:alpha
    container_name: photostructure
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      - PS_SCAN_ALL_DRIVES
      - PS_SCAN_MY_PICTURES
      - PS_SCAN_PATHS
      - PS_LOG_LEVEL
      - PS_LOG_COMPRESS
      - PS_REQUIRE_MAKE_MODEL
      - PS_SYNC_INTERVAL_HOURS
      - PS_FIX_PERMISSIONS
      - UID
      - GID
      - PS_CPU_LOAD_PERCENT
      - PS_PROCESS_PRIORITY
      - PS_ORIGINALS_DIR
#      - PS_LIBRARY_PATH
    volumes:
      - ${PS_CONFIG_DIR_HOST}/photostructure-docker:/ps/config:rw
      - ${PS_LIBRARY_DIR_HOST}:/ps/library:rw
      - ${PS_LOG_DIR_HOST}/photostructure/logs:/ps/logs:rw
      - ${PS_TMP_DIR_HOST}/photostructure:/ps/tmp:rw
      - ${ASSET_DIR_HOST}:${ASSET_DIR_CONTAINER}:rw
    networks:
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.photostructure.rule=Host(`${PHOTOSTRUCTURE_TRAEFIK_HOST}`)"
      - "traefik.http.routers.photostructure.entrypoints=web"
      - "traefik.http.routers.photostructure.middlewares=photostructure-https-redirect"
      - "traefik.http.middlewares.photostructure-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.photostructure-secure.entrypoints=websecure"
      - "traefik.http.routers.photostructure-secure.rule=Host(`${PHOTOSTRUCTURE_TRAEFIK_HOST}`)"
      - "traefik.http.routers.photostructure-secure.tls=true"
      - "traefik.http.routers.photostructure-secure.tls.certresolver=default"
      - "traefik.http.routers.photostructure-secure.service=photostructure"
      - "traefik.http.services.photostructure.loadbalancer.server.port=1787"
#      - "traefik.docker.network=traefik-proxy"
      - "traefik.http.middlewares.photostructure-auth.basicauth.users=${BASICAUTH_USERS}"
      - "traefik.http.routers.photostructure-secure.middlewares=photostructure-auth"
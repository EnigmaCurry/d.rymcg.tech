volumes:
  mosquitto:
  certbot-config:
  certbot-certs:

services:
  config:
    build:
      context: config
    security_opt:
      - no-new-privileges:true
    environment:
      - MOSQUITTO_TRAEFIK_HOST
    volumes:
      - mosquitto:/mosquitto/config
    labels:
      - "backup-volume.stop-during-backup=true"

  mosquitto:
    depends_on: ['config']
    build:
      context: mosquitto
      args:
        MOSQUITTO_IMAGE: ${MOSQUITTO_IMAGE}
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    ports:
      - "8884:8884"
    labels:
      - "backup-volume.stop-during-backup=true"
    entrypoint: ["/mosquitto/mosquitto-entrypoint.sh"]
    healthcheck:
      test: ["CMD", "test", "!", "-f", "/mosquitto/certs/restart-trigger"]
      interval: 10s
      timeout: 5s
    volumes:
      - mosquitto:/mosquitto/config:ro
      - certbot-certs:/mosquitto/certs:ro

  certbot:
    image: certbot/certbot
    environment:
      - CERTBOT_EMAIL=${MOSQUITTO_CERTBOT_EMAIL}
      - CERTBOT_SERVER=${MOSQUITTO_CERTBOT_SERVER}
      - CERTBOT_AGREE_TOS=true
      - CERTBOT_RSA_KEY_SIZE=4096
      - CERTBOT_RENEW_BY_DEFAULT=true
      - CERTBOT_WEBROOT_PATH=/var/www/certbot
    volumes:
      - certbot-config:/etc/letsencrypt
      - certbot-certs:/etc/letsencrypt/live
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


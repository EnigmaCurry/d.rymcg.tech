services:
  mysql-config:
    build:
      context: mysql-config
      args:
        - ONLYOFFICE_CONFIG_YTT_VERSION=${ONLYOFFICE_CONFIG_YTT_VERSION}
    environment:
      - ONLYOFFICE_MYSQL_ROOT_PASSWORD
      - ONLYOFFICE_CORE_MACHINEKEY
      - ONLYOFFICE_MAIL_SERVER_DB_PASS
    volumes:
      - mysql_config:/etc/mysql/conf.d
      - mysql_initdb:/docker-entrypoint-initdb.d
    
  mysql-server:
    image: mysql:${ONLYOFFICE_MYSQL_VERSION}
    depends_on:
      - mysql-config
    environment:
      - MYSQL_ROOT_PASSWORD=${ONLYOFFICE_MYSQL_ROOT_PASSWORD}
    networks:
      - onlyoffice
    stdin_open: true
    tty: true
    restart: unless-stopped
    volumes:
      - mysql_config:/etc/mysql/conf.d
      - mysql_initdb:/docker-entrypoint-initdb.d
      - mysql_data:/var/lib/mysql
     
  community-server:
    image: onlyoffice/communityserver:${ONLYOFFICE_COMMUNITY_SERVER_VERSION}
    depends_on:
      - mysql-server
      - document-server
      - mail-server
      - elasticsearch
    environment:
      - ONLYOFFICE_CORE_MACHINEKEY=${ONLYOFFICE_CORE_MACHINEKEY}
      - CONTROL_PANEL_PORT_80_TCP=80
      - CONTROL_PANEL_PORT_80_TCP_ADDR=control-panel
      - DOCUMENT_SERVER_PORT_80_TCP_ADDR=document-server
      - DOCUMENT_SERVER_JWT_ENABLED=true
      - DOCUMENT_SERVER_JWT_SECRET=${ONLYOFFICE_DOCUMENT_SERVER_JWT_SECRET}
      - DOCUMENT_SERVER_JWT_HEADER=AuthorizationJwt
      - MYSQL_SERVER_ROOT_PASSWORD=${ONLYOFFICE_MYSQL_ROOT_PASSWORD}
      - MYSQL_SERVER_DB_NAME=onlyoffice
      - MYSQL_SERVER_HOST=mysql-server
      - MYSQL_SERVER_USER=onlyoffice_user
      - MYSQL_SERVER_PASS=${ONLYOFFICE_MYSQL_SERVER_PASS}
      - MAIL_SERVER_API_PORT=8081
      - MAIL_SERVER_API_HOST=mail-server
      - MAIL_SERVER_DB_HOST=mysql-server
      - MAIL_SERVER_DB_PORT=3306
      - MAIL_SERVER_DB_NAME=onlyoffice_mailserver
      - MAIL_SERVER_DB_USER=mail_admin
      - MAIL_SERVER_DB_PASS=${ONLYOFFICE_MAIL_SERVER_DB_PASS}
      - ELASTICSEARCH_SERVER_HOST=elasticsearch
      - ELASTICSEARCH_SERVER_HTTPPORT=9200
    networks:
      - onlyoffice
    # ports:
    #  - '80:80'
    #  - '443:443'
    #  - '5222:5222'
    stdin_open: true
    tty: true
    restart: unless-stopped
    privileged: true
#    cgroup: host
    volumes:
      - community_data:/var/www/onlyoffice/Data
      - community_log:/var/log/onlyoffice
      - community_letsencrypt:/etc/letsencrypt
      - document_data:/var/www/onlyoffice/DocumentServerData
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      #- ./certs:/var/www/onlyoffice/Data/certs
     
  elasticsearch:
    image: onlyoffice/elasticsearch:${ONLYOFFICE_ELASTICSEARCH_VERSION}
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g -Dlog4j2.formatMsgNoLookups=true"
      - "indices.fielddata.cache.size=30%"
      - "indices.memory.index_buffer_size=30%" 
      - "ingest.geoip.downloader.enabled=false"
    networks:
      - onlyoffice    
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65535
        hard: 65535
    volumes:
      - es_data:/usr/share/elasticsearch/data
    expose:
      - "9200"
      - "9300"
      
  document-server:
    container_name: document-server
    image: onlyoffice/documentserver:${ONLYOFFICE_DOCUMENT_SERVER_VERSION}
    stdin_open: true
    tty: true
    restart: unless-stopped
    environment:
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLYOFFICE_DOCUMENT_SERVER_JWT_SECRET}
      - JWT_HEADER=AuthorizationJwt
    networks:
      - onlyoffice
    expose:
      - '80'
      - '443'
    volumes:
      - document_data:/var/www/onlyoffice/Data
      - document_log:/var/log/onlyoffice
      - document_fonts:/usr/share/fonts/truetype/custom
      - document_forgotten:/var/lib/onlyoffice/documentserver/App_Data/cache/files/forgotten
       
  mail-server:
    container_name: mail-server
    image: onlyoffice/mailserver:${ONLYOFFICE_MAIL_SERVER_VERSION}
    depends_on:
      - mysql-server
    hostname: ${MAIL_SERVER_HOSTNAME}
    environment:
      - MYSQL_SERVER=mysql-server
      - MYSQL_SERVER_PORT=3306
      - MYSQL_ROOT_USER=mail_admin
      - MYSQL_ROOT_PASSWD=${ONLYOFFICE_MAIL_SERVER_DB_PASS}
      - MYSQL_SERVER_DB_NAME=onlyoffice_mailserver
    networks:
      - onlyoffice
    restart: unless-stopped
    privileged: true
    # ports: ['25:25','143:143','587:587']
    stdin_open: true
    tty: true
    expose:
      - '8081'
      - '3306'
    volumes:
      - mail_data:/var/vmail
      - mail_certs:/etc/pki/tls/mailserver
      - mail_log:/var/log
      
  control-panel:
    container_name: control-panel
    depends_on:
      - document-server
      - mail-server
      - community-server
    image: onlyoffice/controlpanel:${ONLYOFFICE_CONTROL_PANEL_VERSION}
    environment:
      - ONLYOFFICE_CORE_MACHINEKEY=${ONLYOFFICE_CORE_MACHINEKEY}
    expose:
      - '80'
      - '443'
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - controlpanel_data:/var/www/onlyoffice/Data
      - controlpanel_log:/var/log/onlyoffice
    networks:
      - onlyoffice
    stdin_open: true
    tty: true
    
networks:
  onlyoffice:
    driver: 'bridge'
    
volumes:
  mail_data:
  mail_certs:
  mail_log:
  mail_mysql:
  document_data:
  document_log:
  document_fonts:
  document_forgotten:
  community_mysql:
  community_data:
  community_log:
  community_letsencrypt:
  controlpanel_data:
  controlpanel_log:
  mysql_data:
  mysql_config:
  mysql_initdb:
  es_data:

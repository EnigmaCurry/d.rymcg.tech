#@ load("@ytt:data", "data")

#@ tls_proxy_enabled = data.values.layer_7_tls_proxy_enabled == "true"
#@ tls_proxy_routes = data.values.layer_7_tls_proxy_routes

#@yaml/text-templated-strings
#@ if tls_proxy_enabled:
tcp:
  services:
    #@ for route in tls_proxy_routes.split(","):
    #@ domain, ip_address, port = route.split(":")
    #@ service = domain.replace(".","-")
    (@= service @)-proxy:
      loadBalancer:
        servers:
          - address: "(@= ip_address @):(@= port @)"
    #@ end
  routers:
    #@ for route in tls_proxy_routes.split(","):
    #@ domain = route.split(":")[0]
    #@ service = domain.replace(".","-")
    (@= service @)-proxy:
      rule: "HostSNI(`(@= domain @)`)"
      service: "(@= service @)-proxy"
      tls:
        passthrough: true
    #@ end
#@ end

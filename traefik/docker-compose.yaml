volumes:
  traefik:
  geoip_database:
  wireguard:
  wireguard-client:

services:
  config:
    profiles:
      - default
    build:
      context: config
      args:
        TRAEFIK_CONFIG_YTT_VERSION: ${TRAEFIK_CONFIG_YTT_VERSION}
        TRAEFIK_UID: ${TRAEFIK_UID}
        TRAEFIK_GID: ${TRAEFIK_GID}
    user: 0:0
    volumes:
      - traefik:/data
    environment:
      - DOCKER_CONTEXT=${DOCKER_CONTEXT}
      - TRAEFIK_SEND_ANONYMOUS_USAGE=${TRAEFIK_SEND_ANONYMOUS_USAGE:-false}
      - TRAEFIK_CONFIG_VERBOSE=${TRAEFIK_CONFIG_VERBOSE:-false}
      - TRAEFIK_ACME_CA_EMAIL
      - TRAEFIK_LOG_LEVEL=${TRAEFIK_LOG_LEVEL:-info}
      - TRAEFIK_ACME_ENABLED=${TRAEFIK_ACME_ENABLED:-false}
      - TRAEFIK_ACME_CHALLENGE=${TRAEFIK_ACME_CHALLENGE:-tls}
      - TRAEFIK_ACME_CERT_RESOLVER_PRODUCTION=${TRAEFIK_ACME_CERT_RESOLVER_PRODUCTION:-https://acme-v02.api.letsencrypt.org/directory}
      - TRAEFIK_ACME_CERT_RESOLVER_STAGING=${TRAEFIK_ACME_CERT_RESOLVER_STAGING:-https://acme-staging-v02.api.letsencrypt.org/directory}
      - TRAEFIK_ACME_CERT_DOMAINS
      - TRAEFIK_ACME_DNS_PROVIDER
      - TRAEFIK_ACCESS_LOGS_ENABLED=${TRAEFIK_ACCESS_LOGS_ENABLED:-false}
      - TRAEFIK_ACCESS_LOGS_PATH=${TRAEFIK_ACCESS_LOGS_PATH:-/data/access.log}
      - TRAEFIK_ACME_CERT_RESOLVER=${TRAEFIK_ACME_CERT_RESOLVER:-production}
      - TRAEFIK_FILE_PROVIDER_WATCH=${TRAEFIK_FILE_PROVIDER_WATCH:-false}
      - TRAEFIK_FILE_PROVIDER=${TRAEFIK_FILE_PROVIDER:-true}
      - TRAEFIK_DOCKER_PROVIDER=${TRAEFIK_DOCKER_PROVIDER:-true}
      - TRAEFIK_DOCKER_PROVIDER_CONSTRAINTS=${TRAEFIK_DOCKER_PROVIDER_CONSTRAINTS}
      - TRAEFIK_PLUGINS=${TRAEFIK_PLUGINS:-true}
      - TRAEFIK_PLUGIN_BLOCKPATH=${TRAEFIK_PLUGIN_BLOCKPATH:-true}
      - TRAEFIK_PLUGIN_MAXMIND_GEOIP=${TRAEFIK_PLUGIN_MAXMIND_GEOIP:-false}
      - TRAEFIK_PLUGIN_REFERER=${TRAEFIK_PLUGIN_REFERER:-true}
      - TRAEFIK_PLUGIN_HEADER_AUTHORIZATION=${TRAEFIK_PLUGIN_HEADER_AUTHORIZATION:-true}
      - TRAEFIK_WEB_ENTRYPOINT_ENABLED=${TRAEFIK_WEB_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_WEB_ENTRYPOINT_HOST=${TRAEFIK_WEB_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_WEB_ENTRYPOINT_PORT=${TRAEFIK_WEB_ENTRYPOINT_PORT:-80}
      - TRAEFIK_WEB_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_WEB_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_WEBSECURE_ENTRYPOINT_ENABLED=${TRAEFIK_WEBSECURE_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_WEBSECURE_ENTRYPOINT_HOST=${TRAEFIK_WEBSECURE_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_WEBSECURE_ENTRYPOINT_PORT=${TRAEFIK_WEBSECURE_ENTRYPOINT_PORT:-443}
      - TRAEFIK_WEBSECURE_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_WEBSECURE_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_WEB_PLAIN_ENTRYPOINT_ENABLED=${TRAEFIK_WEB_PLAIN_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_WEB_PLAIN_ENTRYPOINT_HOST=${TRAEFIK_WEB_PLAIN_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_WEB_PLAIN_ENTRYPOINT_PORT=${TRAEFIK_WEB_PLAIN_ENTRYPOINT_PORT:-8000}
      - TRAEFIK_WEB_PLAIN_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_WEB_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_MQTT_ENTRYPOINT_ENABLED=${TRAEFIK_MQTT_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_MQTT_ENTRYPOINT_HOST=${TRAEFIK_MQTT_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_MQTT_ENTRYPOINT_PORT=${TRAEFIK_MQTT_ENTRYPOINT_PORT:-8883}
      - TRAEFIK_MQTT_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_MQTT_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_SSH_ENTRYPOINT_ENABLED=${TRAEFIK_SSH_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_SSH_ENTRYPOINT_HOST=${TRAEFIK_SSH_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_SSH_ENTRYPOINT_PORT=${TRAEFIK_SSH_ENTRYPOINT_PORT:-2222}
      - TRAEFIK_SSH_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_SSH_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_XMPP_C2S_ENTRYPOINT_ENABLED=${TRAEFIK_XMPP_C2S_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_XMPP_C2S_ENTRYPOINT_HOST=${TRAEFIK_XMPP_C2S_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_XMPP_C2S_ENTRYPOINT_PORT=${TRAEFIK_XMPP_C2S_ENTRYPOINT_PORT:-5222}
      - TRAEFIK_XMPP_C2S_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_XMPP_C2S_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_XMPP_S2S_ENTRYPOINT_ENABLED=${TRAEFIK_XMPP_S2S_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_XMPP_S2S_ENTRYPOINT_HOST=${TRAEFIK_XMPP_S2S_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_XMPP_S2S_ENTRYPOINT_PORT=${TRAEFIK_XMPP_S2S_ENTRYPOINT_PORT:-5269}
      - TRAEFIK_XMPP_S2S_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_XMPP_S2S_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_MPD_ENTRYPOINT_ENABLED=${TRAEFIK_MPD_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_MPD_ENTRYPOINT_HOST=${TRAEFIK_MPD_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_MPD_ENTRYPOINT_PORT=${TRAEFIK_MPD_ENTRYPOINT_PORT:-6600}
      - TRAEFIK_MPD_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_MPD_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_SNAPCAST_ENTRYPOINT_ENABLED=${TRAEFIK_SNAPCAST_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_SNAPCAST_CONTROL_ENTRYPOINT_ENABLED=${TRAEFIK_SNAPCAST_CONTROL_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_SNAPCAST_ENTRYPOINT_HOST=${TRAEFIK_SNAPCAST_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_SNAPCAST_ENTRYPOINT_PORT=${TRAEFIK_SNAPCAST_ENTRYPOINT_PORT:-1704}
      - TRAEFIK_SNAPCAST_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_SNAPCAST_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_SNAPCAST_CONTROL_ENTRYPOINT_HOST=${TRAEFIK_SNAPCAST_CONTROL_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_SNAPCAST_CONTROL_ENTRYPOINT_PORT=${TRAEFIK_SNAPCAST_CONTROL_ENTRYPOINT_PORT:-1705}
      - TRAEFIK_SNAPCAST_CONTROL_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_SNAPCAST_CONTROL_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_DASHBOARD_ENTRYPOINT_ENABLED=${TRAEFIK_DASHBOARD_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_DASHBOARD_ENTRYPOINT_HOST=${TRAEFIK_DASHBOARD_ENTRYPOINT_HOST:-127.0.0.1}
      - TRAEFIK_DASHBOARD_ENTRYPOINT_PORT=${TRAEFIK_DASHBOARD_ENTRYPOINT_PORT:-8080}
      - TRAEFIK_DASHBOARD_HTTP_AUTH
      - TRAEFIK_REDIS_ENTRYPOINT_ENABLED=${TRAEFIK_REDIS_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_REDIS_ENTRYPOINT_HOST=${TRAEFIK_REDIS_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_REDIS_ENTRYPOINT_PORT=${TRAEFIK_REDIS_ENTRYPOINT_PORT:-6380}
      - TRAEFIK_REDIS_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_REDIS_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_RTMP_ENTRYPOINT_ENABLED=${TRAEFIK_RTMP_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_RTMP_ENTRYPOINT_HOST=${TRAEFIK_RTMP_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_RTMP_ENTRYPOINT_PORT=${TRAEFIK_RTMP_ENTRYPOINT_PORT:-1935}
      - TRAEFIK_RTMP_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS=${TRAEFIK_RTMP_ENTRYPOINT_PROXY_PROTOCOL_TRUSTED_IPS:-}
      - TRAEFIK_VPN_ADDRESS
      - TRAEFIK_VPN_ENABLED=${TRAEFIK_VPN_ENABLED:-false}
      - TRAEFIK_VPN_CLIENT_ENABLED=${TRAEFIK_VPN_CLIENT_ENABLED:-false}
      - TRAEFIK_VPN_CLIENT_PEER_SERVICES
      - TRAEFIK_VPN_ENTRYPOINT_HOST
      - TRAEFIK_VPN_ENTRYPOINT_PORT
      - TRAEFIK_VPN_SUBNET
      - TRAEFIK_VPN_PROXY_ENABLED=${TRAEFIK_VPN_PROXY_ENABLED:-false}
      - TRAEFIK_NETWORK_MODE
      - TRAEFIK_ROOT_DOMAIN
      - TRAEFIK_ERROR_HANDLER_403_SERVICE
      - TRAEFIK_ERROR_HANDLER_404_SERVICE
      - TRAEFIK_ERROR_HANDLER_500_SERVICE
      - TRAEFIK_HEADER_AUTHORIZATION_GROUPS
      - TRAEFIK_STEP_CA_ENABLED=${TRAEFIK_STEP_CA_ENABLED:-false}
      - TRAEFIK_STEP_CA_ENDPOINT
      - TRAEFIK_STEP_CA_FINGERPRINT
      - TRAEFIK_PLUGIN_CERT_AUTH=${TRAEFIK_PLUGIN_CERT_AUTH:-true}
      - TRAEFIK_PLUGIN_MTLS_HEADER=${TRAEFIK_PLUGIN_MTLS_HEADER:-true}
      - TRAEFIK_ACME_CERTIFICATES_DURATION=${TRAEFIK_ACME_CERTIFICATES_DURATION:-2160}
      - TRAEFIK_LAYER_7_TLS_PROXY_ENABLED=${TRAEFIK_LAYER_7_TLS_PROXY_ENABLED:-false}
      - TRAEFIK_LAYER_7_TLS_PROXY_ROUTES=${TRAEFIK_LAYER_7_TLS_PROXY_ROUTES}
      - TRAEFIK_LAYER_4_TCP_UDP_PROXY_ENABLED=${TRAEFIK_LAYER_4_TCP_UDP_PROXY_ENABLED:-false}
      - TRAEFIK_LAYER_4_TCP_UDP_PROXY_ROUTES=${TRAEFIK_LAYER_4_TCP_UDP_PROXY_ROUTES}
      - TRAEFIK_CUSTOM_ENTRYPOINTS=${TRAEFIK_CUSTOM_ENTRYPOINTS}

  traefik:
    profiles:
      - default
    depends_on: ['config']
    build:
      context: .
      args:
        TRAEFIK_IMAGE: ${TRAEFIK_IMAGE}
        BLOCKPATH_MODULE: ${TRAEFIK_BLOCKPATH_MODULE}
        BLOCKPATH_GIT_BRANCH: master
        REFERER_MODULE: ${TRAEFIK_REFERER_MODULE}
        REFERER_GIT_BRANCH: master
        MAXMIND_GEOIP_MODULE: ${TRAEFIK_GEOIP_MODULE}
        MAXMIND_GIT_BRANCH: main
        HEADER_AUTHORIZATION_MODULE: ${TRAEFIK_HEADER_AUTHORIZATION_MODULE}
        HEADER_AUTHORIZATION_GIT_BRANCH: main
        CERT_AUTH_MODULE: ${TRAEFIK_CERT_AUTH_MODULE}
        CERT_AUTH_GIT_BRANCH: main
        MTLS_HEADER_MODULE: ${TRAEFIK_MTLS_HEADER_MODULE}
        MTLS_HEADER_GIT_BRANCH: main
        TRAEFIK_UID: ${TRAEFIK_UID}
        TRAEFIK_GID: ${TRAEFIK_GID}
        TRAEFIK_DOCKER_GID: ${TRAEFIK_DOCKER_GID}
        STEP_CA_ENABLED: ${TRAEFIK_STEP_CA_ENABLED:-false}
        STEP_CA_ENDPOINT: ${TRAEFIK_STEP_CA_ENDPOINT}
        STEP_CA_FINGERPRINT: ${TRAEFIK_STEP_CA_FINGERPRINT}
        STEP_CA_ZERO_CERTS:  ${TRAEFIK_STEP_CA_ZERO_CERTS}
    restart: unless-stopped
    network_mode: ${TRAEFIK_NETWORK_MODE:-host}
    environment:
      - ${TRAEFIK_ACME_DNS_VARNAME_1:-TRAEFIK_ACME_DNS_VARNAME_1_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_2:-TRAEFIK_ACME_DNS_VARNAME_2_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_3:-TRAEFIK_ACME_DNS_VARNAME_3_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_4:-TRAEFIK_ACME_DNS_VARNAME_4_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_5:-TRAEFIK_ACME_DNS_VARNAME_5_NOT_SET}
    command:
      - "--configFile=/data/config/traefik.yml"
    volumes:
      - "traefik:/data"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "geoip_database:/var/lib/traefikgeoip2/"
    labels:
      - "TRAEFIK_HEADER_AUTHORIZATION_GROUPS=${TRAEFIK_HEADER_AUTHORIZATION_GROUPS}"

  geoip_database:
    profiles:
      - geoip_update
    image: maxmindinc/geoipupdate
    restart: on-failure:3
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      - GEOIPUPDATE_ACCOUNT_ID=${TRAEFIK_GEOIPUPDATE_ACCOUNT_ID}
      - GEOIPUPDATE_LICENSE_KEY=${TRAEFIK_GEOIPUPDATE_LICENSE_KEY}
      - GEOIPUPDATE_EDITION_IDS=${TRAEFIK_GEOIPUPDATE_EDITION_IDS}
      - GEOIPUPDATE_FREQUENCY=72
    volumes:
      - "geoip_database:/usr/share/GeoIP"

  wireguard:
    profiles:
      - wireguard
    image: lscr.io/linuxserver/wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: host
    restart: unless-stopped
    # sysctls:
    #   - net.ipv4.conf.all.src_valid_mark=1
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE:-Etc/UTC}
      - SERVERURL=${TRAEFIK_VPN_HOST}
      - SERVERPORT=${TRAEFIK_VPN_PORT}
      - PEERS=${TRAEFIK_VPN_PEERS}
      - INTERNAL_SUBNET=${TRAEFIK_VPN_SUBNET}
      - ALLOWEDIPS=${TRAEFIK_VPN_ALLOWED_IPS}
      - PERSISTENTKEEPALIVE_PEERS=all
    volumes:
      - wireguard:/config
      - /lib/modules:/lib/modules

  wireguard-client-config:
    profiles:
      - wireguard-client
    build:
      context: wireguard-client-config
    environment:
      - TRAEFIK_VPN_ENTRYPOINT_HOST
      - TRAEFIK_VPN_CLIENT_INTERFACE_ADDRESS
      - TRAEFIK_VPN_CLIENT_INTERFACE_PRIVATE_KEY
      - TRAEFIK_VPN_CLIENT_INTERFACE_LISTEN_PORT
      - TRAEFIK_VPN_CLIENT_PEER_PUBLIC_KEY
      - TRAEFIK_VPN_CLIENT_PEER_PRESHARED_KEY
      - TRAEFIK_VPN_CLIENT_PEER_ENDPOINT
      - TRAEFIK_VPN_CLIENT_PEER_ALLOWED_IPS
    volumes:
      - wireguard-client:/config

  wireguard-client:
    profiles:
      - wireguard-client
    depends_on: ['wireguard-client-config']
    image: lscr.io/linuxserver/wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: host
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE:-Etc/UTC}
      - PERSISTENTKEEPALIVE_PEERS=all
    volumes:
      - wireguard-client:/config
      - /lib/modules:/lib/modules

  error-pages:
    profiles:
      - error-pages
    image: ${TRAEFIK_ERROR_PAGES_IMAGE}
    environment:
      TEMPLATE_NAME: ${TRAEFIK_ERROR_PAGES_TEMPLATE}
    labels:
      traefik.enable: true
      # use as "fallback" for any NON-registered services (with priority below normal)
      traefik.http.routers.error-pages-router.rule: HostRegexp(`.+`)
      traefik.http.routers.error-pages-router.ruleSyntax: v3
      traefik.http.routers.error-pages-router.priority: 10
      traefik.http.routers.error-pages-router.entrypoints: web,websecure
      traefik.http.routers.error-pages-router.middlewares: error-pages-middleware
      traefik.http.middlewares.error-pages-middleware.errors.status: 400-599
      traefik.http.middlewares.error-pages-middleware.errors.service: error-pages-service@docker
      traefik.http.middlewares.error-pages-middleware.errors.query: /{status}.html
      traefik.http.services.error-pages-service.loadbalancer.server.port: 8080
    depends_on:
      - traefik

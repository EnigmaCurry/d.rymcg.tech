version: "3.9"

volumes:
  traefik:
  geoip_database:
  wireguard:

services:
  config:
    profiles:
      - default
    build:
      context: config
      args:
        TRAEFIK_CONFIG_YTT_VERSION: ${TRAEFIK_CONFIG_YTT_VERSION}
    security_opt:
      - no-new-privileges:true
    environment:
      - TRAEFIK_SEND_ANONYMOUS_USAGE=${TRAEFIK_SEND_ANONYMOUS_USAGE:-false}
      - TRAEFIK_CONFIG_VERBOSE=${TRAEFIK_CONFIG_VERBOSE:-false}
      - TRAEFIK_ACME_CA_EMAIL
      - TRAEFIK_LOG_LEVEL=${TRAEFIK_LOG_LEVEL:-info}
      - TRAEFIK_ACME_ENABLED=${TRAEFIK_ACME_ENABLED:-false}
      - TRAEFIK_ACME_CHALLENGE=${TRAEFIK_ACME_CHALLENGE:-tls}
      - TRAEFIK_ACME_CERT_DOMAINS
      - TRAEFIK_ACME_DNS_PROVIDER
      - TRAEFIK_ACCESS_LOGS_ENABLED=${TRAEFIK_ACCESS_LOGS_ENABLED:-false}
      - TRAEFIK_ACCESS_LOGS_PATH=${TRAEFIK_ACCESS_LOGS_PATH:-/data/access.log}
      - TRAEFIK_ACME_CERT_RESOLVER=${TRAEFIK_ACME_CERT_RESOLVER:-production}
      - TRAEFIK_FILE_PROVIDER_WATCH=${TRAEFIK_FILE_PROVIDER_WATCH:-false}
      - TRAEFIK_FILE_PROVIDER=${TRAEFIK_FILE_PROVIDER:-true}
      - TRAEFIK_DOCKER_PROVIDER=${TRAEFIK_DOCKER_PROVIDER:-true}
      - TRAEFIK_PLUGINS=${TRAEFIK_PLUGINS:-true}
      - TRAEFIK_PLUGIN_BLOCKPATH=${TRAEFIK_PLUGIN_BLOCKPATH:-true}
      - TRAEFIK_PLUGIN_MAXMIND_GEOIP=${TRAEFIK_PLUGIN_MAXMIND_GEOIP:-false}
      - TRAEFIK_WEB_ENTRYPOINT_ENABLED=${TRAEFIK_WEB_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_WEB_ENTRYPOINT_HOST=${TRAEFIK_WEB_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_WEB_ENTRYPOINT_PORT=${TRAEFIK_WEB_ENTRYPOINT_PORT:-80}
      - TRAEFIK_WEBSECURE_ENTRYPOINT_ENABLED=${TRAEFIK_WEBSECURE_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_WEBSECURE_ENTRYPOINT_HOST=${TRAEFIK_WEBSECURE_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_WEBSECURE_ENTRYPOINT_PORT=${TRAEFIK_WEBSECURE_ENTRYPOINT_PORT:-443}
      - TRAEFIK_MQTT_ENTRYPOINT_ENABLED=${TRAEFIK_MQTT_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_MQTT_ENTRYPOINT_HOST=${TRAEFIK_MQTT_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_MQTT_ENTRYPOINT_PORT=${TRAEFIK_MQTT_ENTRYPOINT_PORT:-8883}
      - TRAEFIK_SSH_ENTRYPOINT_ENABLED=${TRAEFIK_SSH_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_SSH_ENTRYPOINT_HOST=${TRAEFIK_SSH_ENTRYPOINT_HOST:-0.0.0.0}
      - TRAEFIK_SSH_ENTRYPOINT_PORT=${TRAEFIK_SSH_ENTRYPOINT_PORT:-2222}
      - TRAEFIK_DASHBOARD_ENTRYPOINT_ENABLED=${TRAEFIK_DASHBOARD_ENTRYPOINT_ENABLED:-false}
      - TRAEFIK_DASHBOARD_ENTRYPOINT_HOST=${TRAEFIK_DASHBOARD_ENTRYPOINT_HOST:-127.0.0.1}
      - TRAEFIK_DASHBOARD_ENTRYPOINT_PORT=${TRAEFIK_DASHBOARD_ENTRYPOINT_PORT:-8080}
      - TRAEFIK_DASHBOARD_AUTH
      - TRAEFIK_VPN_ENABLED=${TRAEFIK_VPN_ENABLED:-false}
      - TRAEFIK_VPN_ENTRYPOINT_HOST
      - TRAEFIK_VPN_ENTRYPOINT_PORT
      - TRAEFIK_VPN_SUBNET
      - TRAEFIK_VPN_PROXY_ENABLED=${TRAEFIK_VPN_PROXY_ENABLED:-false}
    volumes:
      - traefik:/data

  traefik:
    profiles:
      - default
    depends_on: ['geoip_database','config']
    build:
      context: .
      args:
        TRAEFIK_IMAGE: ${TRAEFIK_IMAGE}
        BLOCKPATH_MODULE: github.com/traefik/plugin-blockpath
        BLOCKPATH_GIT_BRANCH: master
        MAXMIND_GEOIP_MODULE: github.com/GiGInnovationLabs/traefikgeoip2
        MAXMIND_GIT_BRANCH: main
    container_name: "traefik"
    restart: unless-stopped
    network_mode: ${TRAEFIK_NETWORK_MODE:-host}
    privileged: true
    environment:
      - ${TRAEFIK_ACME_DNS_VARNAME_1:-TRAEFIK_ACME_DNS_VARNAME_1_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_2:-TRAEFIK_ACME_DNS_VARNAME_2_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_3:-TRAEFIK_ACME_DNS_VARNAME_3_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_4:-TRAEFIK_ACME_DNS_VARNAME_4_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_5:-TRAEFIK_ACME_DNS_VARNAME_5_NOT_SET}
    command:
      - "--configFile=/data/config/traefik.yml"
    volumes:
      - "traefik:/data"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "geoip_database:/var/lib/traefikgeoip2/"

  geoip_database:
    profiles:
      - geoip_update
    image: maxmindinc/geoipupdate
    restart: on-failure:3
    environment:
      - GEOIPUPDATE_ACCOUNT_ID=${TRAEFIK_GEOIPUPDATE_ACCOUNT_ID}
      - GEOIPUPDATE_LICENSE_KEY=${TRAEFIK_GEOIPUPDATE_LICENSE_KEY}
      - 'GEOIPUPDATE_EDITION_IDS=${TRAEFIK_GEOIPUPDATE_EDITION_IDS}'
      - GEOIPUPDATE_FREQUENCY=72
    volumes:
      - "geoip_database:/usr/share/GeoIP"

  wireguard:
    profiles:
      - wireguard
    image: lscr.io/linuxserver/wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    restart: unless-stopped
    ports:
      - ${WIREGUARD_HOST_PORT:-51820}:${WIREGUARD_HOST_PORT:-51820}/udp
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE:-Etc/UTC}
      - SERVERURL=${WIREGUARD_TRAEFIK_HOST:-}
      - SERVERPORT=${WIREGUARD_HOST_PORT:-}
      - PEERS=${WIREGUARD_PEERS:-}
      - PEERDNS=${WIREGUARD_PEERDNS:-}
      - INTERNAL_SUBNET=${WIREGUARD_SUBNET:-}
      - ALLOWEDIPS=${WIREGUARD_ALLOWEDIPS:-}
    volumes:
      - wireguard:/config
      - /lib/modules:/lib/modules

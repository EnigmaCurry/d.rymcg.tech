version: "3.3"

volumes:
  traefik:
  geoip_database:

services:
  config:
    build:
      context: config
      args:
        TRAEFIK_CONFIG_YTT_VERSION: ${TRAEFIK_CONFIG_YTT_VERSION}
    security_opt:
      - no-new-privileges:true
    environment:
      - TRAEFIK_SEND_ANONYMOUS_USAGE=${TRAEFIK_SEND_ANONYMOUS_USAGE:-false}
      - TRAEFIK_CONFIG_VERBOSE=${TRAEFIK_CONFIG_VERBOSE:-false}
      - TRAEFIK_ACME_CA_EMAIL
      - TRAEFIK_DASHBOARD_AUTH
      - TRAEFIK_DASHBOARD
      - TRAEFIK_LOG_LEVEL=${TRAEFIK_LOG_LEVEL:-info}
      - TRAEFIK_ACME_CHALLENGE=${TRAEFIK_ACME_CHALLENGE:-tls}
      - TRAEFIK_ACME_CERT_DOMAINS
      - TRAEFIK_ACME_DNS_PROVIDER
      - TRAEFIK_ACCESS_LOGS_ENABLED=${TRAEFIK_ACCESS_LOGS_ENABLED:-false}
      - TRAEFIK_ACCESS_LOGS_PATH=${TRAEFIK_ACCESS_LOGS_PATH:-/data/access.log}
      - TRAEFIK_ACME_CERT_RESOLVER=${TRAEFIK_ACME_CERT_RESOLVER:-production}
      - TRAEFIK_FILE_PROVIDER_WATCH=${TRAEFIK_FILE_PROVIDER_WATCH:-false}
      - TRAEFIK_FILE_PROVIDER=${TRAEFIK_FILE_PROVIDER:-true}
      - TRAEFIK_DOCKER_PROVIDER=${TRAEFIK_DOCKER_PROVIDER:-true}
      - TRAEFIK_PLUGINS=${TRAEFIK_PLUGINS:-true}
      - TRAEFIK_PLUGIN_BLOCKPATH=${TRAEFIK_PLUGIN_BLOCKPATH:-true}
      - TRAEFIK_PLUGIN_MAXMIND_GEOIP=${TRAEFIK_PLUGIN_MAXMIND_GEOIP:-false}
    volumes:
      - traefik:/data

  geoip_database:
    image: maxmindinc/geoipupdate
    restart: unless-stopped
    environment:
      - GEOIPUPDATE_ACCOUNT_ID=${TRAEFIK_GEOIPUPDATE_ACCOUNT_ID}
      - GEOIPUPDATE_LICENSE_KEY=${TRAEFIK_GEOIPUPDATE_LICENSE_KEY}
      - 'GEOIPUPDATE_EDITION_IDS=${TRAEFIK_GEOIPUPDATE_EDITION_IDS}'
      - GEOIPUPDATE_FREQUENCY=72
    volumes:
      - "geoip_database:/usr/share/GeoIP"

  traefik:
    depends_on: ['geoip_database','config']
    build:
      context: .
      args:
        TRAEFIK_IMAGE: ${TRAEFIK_IMAGE}
        BLOCKPATH_MODULE: github.com/traefik/plugin-blockpath
        BLOCKPATH_GIT_BRANCH: master
        MAXMIND_GEOIP_MODULE: github.com/GiGInnovationLabs/traefikgeoip2
        MAXMIND_GIT_BRANCH: main
    container_name: "traefik"
    restart: unless-stopped
    network_mode: host
    security_opt:
      - no-new-privileges:true
    environment:
      - ${TRAEFIK_ACME_DNS_VARNAME_1:-TRAEFIK_ACME_DNS_VARNAME_1_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_2:-TRAEFIK_ACME_DNS_VARNAME_2_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_3:-TRAEFIK_ACME_DNS_VARNAME_3_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_4:-TRAEFIK_ACME_DNS_VARNAME_4_NOT_SET}
      - ${TRAEFIK_ACME_DNS_VARNAME_5:-TRAEFIK_ACME_DNS_VARNAME_5_NOT_SET}
    command:
      - "--configFile=/data/config/traefik.yml"
    volumes:
      - "traefik:/data"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "geoip_database:/var/lib/traefikgeoip2/"

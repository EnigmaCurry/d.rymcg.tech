version: "3.3"

volumes:
  music:
  mopidy_config:
  snapserver_config:

services:
  config:
    build:
      context: config
    security_opt:
      - no-new-privileges:true
    environment:
      - MOPIDY_MPD_PASSWORD
    volumes:
      - mopidy_config:/mopidy_config
      - snapserver_config:/snapserver_config

  mopidy:
    depends_on: ['config']
    build:
      context: mopidy
    # ports:
    #   - "6680:6680"
    #   - "6600:6600"
    volumes:
      - music:/media/music
      - mopidy_config:/home/mopidy/.config/mopidy
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.mopidy.rule=ClientIP(`0.0.0.0/0`)"
      - "traefik.tcp.routers.mopidy.entrypoints=mpd"
      - "traefik.tcp.routers.mopidy.service=mopidy"
      - "traefik.tcp.services.mopidy.loadBalancer.server.port=6600"
      - "traefik.tcp.middlewares.mopidy-${MOPIDY_INSTANCE:-default}-whitelist.ipwhitelist.sourcerange=${MOPIDY_IP_SOURCERANGE}"
      - "traefik.tcp.routers.mopidy.middlewares=mopidy-${MOPIDY_INSTANCE:-default}-whitelist"

  snapserver:
    depends_on: ['config']
    build:
      context: snapserver
    # ports:
    #   - "1704:1704"
    #   - "1705:1705"
    volumes:
      - snapserver_config:/etc/snapserver
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.snapserver-${MOPIDY_INSTANCE:-default}.loadbalancer.server.port=1780"
      - "traefik.http.routers.snapserver-${MOPIDY_INSTANCE:-default}.rule=Host(`${MOPIDY_TRAEFIK_HOST}`)"
      - "traefik.http.routers.snapserver-${MOPIDY_INSTANCE:-default}.entrypoints=websecure"
      - "traefik.http.middlewares.snapserver-${MOPIDY_INSTANCE:-default}-whitelist.ipwhitelist.sourcerange=${MOPIDY_IP_SOURCERANGE}"
      - "traefik.http.routers.snapserver-${MOPIDY_INSTANCE:-default}.middlewares=snapserver-${MOPIDY_INSTANCE:-default}-whitelist"

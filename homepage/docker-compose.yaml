volumes:
  config:

networks:
  # Internal sandbox network with no outbound NAT
  sandbox:
    internal: true

services:
  docker-socket-proxy:
    privileged: true
    image: ${HOMEPAGE_DOCKER_SOCKET_PROXY_IMAGE}
    restart: unless-stopped
    networks: [sandbox]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro,z
    environment:
      - LOG_LEVEL=info         # debug|info|notice|warning|err|crit|alert|emerg
      # ---- Global HTTP method gate ----
      - POST=0                 # 0 = block all POST/DELETE/PATCH (read-only proxy). 1 = allow writes.
      # ---- Basic health/info ----
      - PING=1                 # GET /_ping health.
      - VERSION=1              # GET /version.
      - EVENTS=1               # GET /events stream (optional live updates).
      # ---- Reads Homepage usually needs ----
      - INFO=1                 # GET /info (daemon info).
      - CONTAINERS=1           # GET /containers/json and /containers/{id}/json.
    read_only: true
    tmpfs:
      - /tmp:rw,nosuid,nodev,noexec,size=16m
      - /run:rw,nosuid,nodev,noexec,size=1m
      - /var/lib/haproxy:rw,nosuid,nodev,noexec,size=1m
      - /var/cache/haproxy:rw,nosuid,nodev,noexec,size=1m
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:2375/_ping"]
      interval: 30s
      timeout: 3s
      retries: 3

  homepage:
    build:
      context: homepage
      args:
        HOMEPAGE_IMAGE: ${HOMEPAGE_IMAGE}
    restart: unless-stopped
    networks: [default, sandbox]
    environment:
      HOMEPAGE_DOCKER_HOST: http://docker-socket-proxy:2375
      RELOAD_WEBHOOK_HMAC_SECRET: ${HOMEPAGE_RELOADER_HMAC_SECRET}
      RELOAD_WEBHOOK_PATH_PREFIX: ${HOMEPAGE_RELOADER_PATH_PREFIX}
      HOMEPAGE_TEMPLATE_REPO: ${HOMEPAGE_TEMPLATE_REPO}
      HOMEPAGE_ALLOWED_HOSTS: ${HOMEPAGE_ALLOWED_HOSTS}
    volumes: [] # volumes are defined in docker-compose.instance.yaml
    labels: []
    read_only: true
    cap_drop: ["ALL"]
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:rw,nosuid,nodev,noexec,size=64m

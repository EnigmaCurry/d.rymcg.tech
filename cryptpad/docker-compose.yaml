version: "3.9"

volumes:
  blob:
  block:
  customize:
  data:
  datastore:
  config:

services:
  config:
    build:
      context: config
    security_opt:
      - no-new-privileges:true
    environment:
      - CRYPTPAD_TRAEFIK_HOST
      - CRYPTPAD_SANDBOX_DOMAIN
      - CRYPTPAD_ALLOWED_ORIGINS
      - CPAD_MAIN_DOMAIN=${CRYPTPAD_TRAEFIK_HOST}
      - CPAD_SANDBOX_DOMAIN=${CRYPTPAD_SANDBOX_DOMAIN}
      - ADMIN_KEY=${CRYPTPAD_ADMIN_KEY}
      - ADMIN_EMAIL=${CRYPTPAD_ADMIN_EMAIL}
      - PRINT_CONFIG
      - DEFAULT_STORAGE_LIMIT=${CRYPTPAD_DEFAULT_STORAGE_LIMIT}
      - MAX_UPLOAD_SIZE=${CRYPTPAD_MAX_UPLOAD_SIZE}
      - BLOCK_DAILY_CHECK=${CRYPTPAD_BLOCK_DAILY_CHECK}
      - CRYPTPAD_LOG_LEVEL=${CRYPTPAD_LOG_LEVEL:-warn}
    volumes:
      - config:/cryptpad/config

  cryptpad:
    depends_on: ['config']
    build:
      context: cryptpad
      args:
        CRYPTPAD_VERSION: ${CRYPTPAD_VERSION}
    #image: promasu/cryptpad:${CRYPTPAD_VERSION}
    restart: unless-stopped
    environment:
      - CPAD_MAIN_DOMAIN=${CRYPTPAD_TRAEFIK_HOST}
      - CPAD_SANDBOX_DOMAIN=${CRYPTPAD_SANDBOX_DOMAIN}
      # Traefik can't use HTTP2 to communicate with cryptpad_websocket
      # A workaround is disabling HTTP2 in Nginx
      - CPAD_HTTP2_DISABLE=true
      - CPAD_REALIP_RECURSIVE=on
      - CPAD_REALIP_HEADER=X-Forwarded-For
      - TZ=America/New_York
    volumes:
      - blob:/cryptpad/blob
      - block:/cryptpad/block
      - customize:/cryptpad/customize
      - data:/cryptpad/data
      - datastore:/cryptpad/datastore
      - config:/cryptpad/config
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ## All labels defined in docker-compose.instance.yaml
    labels: []
    ulimits:
      nofile:
        soft: 1000000
        hard: 1000000
    # security_opt:
    #   - no-new-privileges:true
    # cap_drop:
    #   - ALL
    # cap_add:
    #   - SETGID
    #   - SETUID
    #   - CHOWN
    #   - DAC_OVERRIDE

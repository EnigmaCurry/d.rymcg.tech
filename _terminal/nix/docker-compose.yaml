version: "3.9"

volumes:
  home:
    labels:
      - "tech.rymcg.d.shell=true"

services:
  nix-base:
    profiles:
      - build-base
    image: ${NIX_BASE_IMAGE_TAG}
    build:
      context: nix-user
      dockerfile: Dockerfile.base
      args:
        DOCKER_IMAGE: debian:bullseye-slim
        NIX_USER_NAME: ${NIX_USER_NAME}
        NIX_USER_UID: ${NIX_USER_UID}
        NIX_USER_GID: ${NIX_USER_GID}

  nix-common:
    profiles:
      - build-common
    image: ${NIX_COMMON_IMAGE_TAG}
    build:
      context: nix-user
      dockerfile: Dockerfile.common
      args:
        BASE_IMAGE: ${NIX_BASE_IMAGE_TAG}
        NIX_HOMEMANAGER_VERSION: ${NIX_HOMEMANAGER_VERSION}
        NIX_GIT_D_RYMCG_TECH_CLONE: ${NIX_GIT_D_RYMCG_TECH_CLONE}
        NIX_GIT_D_RYMCG_TECH_REPO: ${NIX_GIT_D_RYMCG_TECH_REPO}
        NIX_GIT_D_RYMCG_TECH_REF: ${NIX_GIT_D_RYMCG_TECH_REF}

  nix-user:
    profiles:
      - build-user
    image: ${NIX_USER_IMAGE_TAG}
    build:
      context: nix-user
      args:
        COMMON_BASE_IMAGE: ${NIX_COMMON_IMAGE_TAG}
        NIX_GIT_USERNAME: ${NIX_GIT_USERNAME}
        NIX_GIT_EMAIL: ${NIX_GIT_EMAIL}
        NIX_DOCKER_SSH_HOST: ${NIX_DOCKER_SSH_HOST}
        NIX_DOCKER_SSH_USER: ${NIX_DOCKER_SSH_USER}
        NIX_DOCKER_SSH_PORT: ${NIX_DOCKER_SSH_PORT}
    volumes:
      - home:/home/${NIX_USER_NAME}

  shell:
    profiles:
      - run-shell
    image: ${NIX_USER_IMAGE_TAG}
    hostname: ${NIX_GENERIC_PREFIX}-${INSTANCE:-default}${NIX_INSTANCE_SUFFIX}
    restart: unless-stopped
    volumes:
      - home:/home/${NIX_USER_NAME}
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # sysctls:
    #   - net.ipv4.ip_unprivileged_port_start=1024
    environment:
      - INSTANCE_SUFFIX
    labels:
      - "tech.rymcg.d.shell=true"
      - "tech.rymcg.d.shell.instance=${INSTANCE:-default}"

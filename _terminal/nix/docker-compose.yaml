version: "3.9"

volumes:
  user-git:

services:
  nix-user:
    container_name: nix-${INSTANCE:-default}
    hostname: nix-${INSTANCE:-default}
    build:
      context: nix-user
      args:
        NIX_USER_NAME: ${NIX_USER_NAME}
        NIX_USER_UID: ${NIX_USER_UID}
        NIX_USER_GID: ${NIX_USER_GID}
        NIX_HOMEMANAGER_HOME: ${NIX_HOMEMANAGER_HOME}
        NIX_HOMEMANAGER_VERSION: ${NIX_HOMEMANAGER_VERSION}
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    sysctls:
      - net.ipv4.ip_unprivileged_port_start=1024
    restart: unless-stopped
    volumes:
      - user-git:/home/${NIX_USER_NAME}/git
    environment:
      - NIX_HOMEMANAGER_VERSION
      - NIX_HOMEMANAGER_HOME
      - NIX_GIT_CLONE
      - NIX_GIT_REPO
      - NIX_GIT_BRANCH
      - NIX_USER_NAME
      - NIX_DOCKER_SSH_HOST
      - NIX_DOCKER_SSH_USER
      - NIX_DOCKER_SSH_PORT


version: "3.9"

volumes:
  nix:
  home:

services:
  nix-user:
    container_name: nix-${INSTANCE:-default}
    hostname: nix-${INSTANCE:-default}
    build:
      context: nix-user
      args:
        DOCKER_IMAGE: debian:bullseye-slim
        NIX_USER_NAME: ${NIX_USER_NAME}
        NIX_USER_UID: ${NIX_USER_UID}
        NIX_USER_GID: ${NIX_USER_GID}
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # sysctls:
    #   - net.ipv4.ip_unprivileged_port_start=1024
    restart: unless-stopped
    volumes:
      - home:/home/${NIX_USER_NAME}
      - nix:/nix
    environment:
      - NIX_USER_NAME
      - NIX_HOMEMANAGER_VERSION
      - NIX_GIT_USERNAME
      - NIX_GIT_EMAIL
      - NIX_GIT_CLONE
      - NIX_GIT_REPO
      - NIX_GIT_BRANCH
      - NIX_DOCKER_SSH_HOST
      - NIX_DOCKER_SSH_USER
      - NIX_DOCKER_SSH_PORT


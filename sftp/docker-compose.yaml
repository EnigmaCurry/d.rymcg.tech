version: "3.9"

volumes:
  ssh-config:
  sftp-data:
  ## List the external volumes you want to share with select sftp users:
  ryan-web:
    name: thttpd_files
    external: true

services:
  config:
    image: sftp-sftp
    cap_add:
      - LINUX_IMMUTABLE
      - CHOWN
      - DAC_OVERRIDE
    profiles:
      - config
    volumes:
      - ssh-config:/etc/ssh
    entrypoint: ""

  sftp:
    image: sftp-sftp
    build:
      context: ./
    restart: unless-stopped
    volumes:
      - ssh-config:/etc/ssh
      - sftp-data:/data
      ## Mount extra volumes per-user here:
      ## Must mount these per-user as /data/$user-chroot/$user/$volume:
      ## See sshd_config ChrootDirectory setting.
      - ryan-web:/data/ryan-chroot/ryan/web
    ports:
      - ${SFTP_PORT}:2000
    environment:
      - SFTP_KEYFILE_URL
      - SFTP_USERS
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
       - CHOWN
       - DAC_OVERRIDE
       - SYS_CHROOT
       - AUDIT_WRITE
       - SETGID
       - SETUID
       - FOWNER
       ### Unused capabilities:
       # - AUDIT_CONTROL
       # - AUDIT_READ
       # - BLOCK_SUSPEND
       # - DAC_READ_SEARCH
       # - FSETID
       # - IPC_LOCK
       # - IPC_OWNER
       # - KILL
       # - LEASE
       # - LINUX_IMMUTABLE
       # - MAC_ADMIN
       # - MAC_OVERRIDE
       # - MKNOD
       # - NET_ADMIN
       # - NET_BIND_SERVICE
       # - NET_BROADCAST
       # - NET_RAW
       # - SETFCAP
       # - SETPCAP
       # - SYS_ADMIN
       # - SYS_BOOT
       # - SYSLOG
       # - SYS_MODULE
       # - SYS_NICE
       # - SYS_PACCT
       # - SYS_PTRACE
       # - SYS_RAWIO
       # - SYS_RESOURCE
       # - SYS_TIME
       # - SYS_TTY_CONFIG
       # - WAKE_ALARM

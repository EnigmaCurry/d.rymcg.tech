#! This is a ytt template file for docker-compose.override.yaml
#! References:
#!   https://carvel.dev/ytt
#!   https://docs.docker.com/compose/extends/#adding-and-overriding-configuration
#!   https://github.com/enigmacurry/d.rymcg.tech#overriding-docker-composeyaml-per-instance

#! ### Standard project vars:
#@ load("@ytt:data", "data")
#@ project = data.values.project
#@ instance = data.values.instance
#@ context = data.values.context
#@ traefik_host = data.values.traefik_host
#@ ip_sourcerange = data.values.ip_sourcerange
#@ acme_new_account_ip_sourcerange = data.values.acme_new_account_ip_sourcerange
#@ enabled_middlewares = []
#@ acme_new_account_enabled_middlewares = []

#@yaml/text-templated-strings
services:
  step-ca:
    #@ service = "step-ca"
    labels:
      - "backup-volume.stop-during-backup=true"
      #! Services must opt-in to be proxied by Traefik:
      - "traefik.enable=true"

      #! 'router' is the fully qualified key in traefik for this router/service: project + instance + service
      #@ router = "{}-{}-{}".format(project,instance,service)
      #@ full_service = "{}-{}-{}".format(project,instance,service)
      #! The host matching router rule:
      - "traefik.http.routers.(@= router @).rule=Host(`(@= traefik_host @)`)"
      - "traefik.http.routers.(@= router @).service=(@= full_service @)"
      - "traefik.http.routers.(@= router @).entrypoints=websecure"
      #@ enabled_middlewares.append("{}-ipallowlist".format(router))
      - "traefik.http.middlewares.(@= router @)-ipallowlist.ipallowlist.sourcerange=(@= ip_sourcerange @)"
      #! Apply all middlewares (do this at the end!)
      - "traefik.http.routers.(@= router @).middlewares=(@= ','.join(enabled_middlewares) @)"

      #! 'router' is the fully qualified key in traefik for this router/service: project + instance + service
      #@ router = "{}-{}-{}-acme-new-account".format(project,instance,service)
      #! The host matching router rule:
      - "traefik.http.routers.(@= router @).rule=Host(`(@= traefik_host @)`) && Path(`/acme/acme/new-account`)"
      - "traefik.http.routers.(@= router @).service=(@= full_service @)"
      - "traefik.http.routers.(@= router @).entrypoints=websecure"
      #@ acme_new_account_enabled_middlewares.append("{}-ipallowlist".format(router))
      - "traefik.http.middlewares.(@= router @)-ipallowlist.ipallowlist.sourcerange=(@= acme_new_account_ip_sourcerange @)"
      #! Apply all middlewares (do this at the end!)
      - "traefik.http.routers.(@= router @).middlewares=(@= ','.join(acme_new_account_enabled_middlewares) @)"

      - "traefik.http.services.(@= full_service @).loadbalancer.server.port=9000"
      - "traefik.http.services.(@= full_service @).loadbalancer.server.scheme=https"
      - "traefik.http.services.(@= full_service @).loadbalancer.serversTransport=insecure-https@file"

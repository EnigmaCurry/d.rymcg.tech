#!/bin/bash
set -eu
: "${TURN_DOMAIN:?}"
: "${TURN_LISTEN_PORT:?}"
: "${TURN_TLS_PORT:?}"
: "${COTURN_STATIC_AUTH_SECRET:?}"
: "${RESTART_MINUTES:=30}"
: "${TTL_FACTOR:=2}"

TEMPLATE=/etc/pairdrop/rtc_config.template.json
OUT=/etc/pairdrop/rtc_config.json

mint() {
  now=$(date -u +%s)
  ttl=$(( RESTART_MINUTES * TTL_FACTOR * 60 ))
  exp=$(( now + ttl ))
  user="${exp}:pairdrop"
  pass=$(printf %s "$user" \
    | openssl dgst -sha1 -mac HMAC -macopt "key:${COTURN_STATIC_AUTH_SECRET}" -binary \
    | openssl base64)

  # write atomically
  tmp="${OUT}.tmp"
  env TURN_DOMAIN="$TURN_DOMAIN" TURN_LISTEN_PORT="$TURN_LISTEN_PORT" \
      TURN_TLS_PORT="$TURN_TLS_PORT" TURN_USERNAME="$user" TURN_PASSWORD="$pass" \
    envsubst '${TURN_DOMAIN} ${TURN_LISTEN_PORT} ${TURN_TLS_PORT} ${TURN_USERNAME} ${TURN_PASSWORD}' \
      < "$TEMPLATE" > "$tmp"
  mv -f "$tmp" "$OUT"
  sed 's/"credential": *".*"/"credential": "***"/' "$OUT" >&2
}

mint

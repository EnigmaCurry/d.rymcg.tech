version: "3.9"
services:
  ## The name of your service:
  ${CREATE_TEMPLATE_PROJECT_NAME}:
    ## Build the docker image from the local Dockerfile:
    build:
      context: whoami
      args:
        UID: ${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_UID}
        GID: ${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_GID}
        USERNAME: ${CREATE_TEMPLATE_PROJECT_NAME}
    ## The docker image can be pulled instead of built if specified:
    #image: "traefik/whoami"

    ## user is optional, it overrides the USER of the Dockerfile
    user: ${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_UID}:${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_GID}
    ## Setting a restart policy is important, especially in case of system reboot:
    restart: unless-stopped
    labels:
      ## These labels configure Traefik to proxy for this service:
      ## Traefik ignores all containers by default, you must explicitly set traefik.enable=true:
      - "traefik.enable=true"

      ## ${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_TRAEFIK_HOST is the domain name of the service.
      ## ${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_INSTANCE is the name of the instance if running more than one ('default' by default).
      ## The service, router, and middle ware are all namespaced with the ${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_INSTANCE name.

      ## This is the router rule that matches the domain name with the service:
      - "traefik.http.routers.${CREATE_TEMPLATE_PROJECT_NAME}-${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_INSTANCE:-default}.rule=Host(`${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_TRAEFIK_HOST}`)"
      ## loadbalancer.server.port is only needed if the Dockerfile for the image did not use EXPOSE:
      - "traefik.http.services.${CREATE_TEMPLATE_PROJECT_NAME}-${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_INSTANCE:-default}.loadbalancer.server.port=8000"
      ## This exposes the service on the Traefik entrypoint named websecure (on port :443)
      - "traefik.http.routers.${CREATE_TEMPLATE_PROJECT_NAME}-${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_INSTANCE:-default}.entrypoints=websecure"
      ## This creates a middleware to filter traffic by client source IP address range:
      - "traefik.http.middlewares.${CREATE_TEMPLATE_PROJECT_NAME}-${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_INSTANCE:-default}-whitelist.ipwhitelist.sourcerange=${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_IP_SOURCERANGE}"
      ## This enables the middleware to operate on this service:
      - "traefik.http.routers.${CREATE_TEMPLATE_PROJECT_NAME}-${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_INSTANCE:-default}.middlewares=${CREATE_TEMPLATE_PROJECT_NAME}-${${CREATE_TEMPLATE_PROJECT_NAME_UPPERCASE}_INSTANCE:-default}-whitelist"

    ## Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    sysctls:
      - net.ipv4.ip_unprivileged_port_start=1024
    cap_add:
      ## These are all of the available Linux system capabilities that containers can access
      ## https://man.archlinux.org/man/capabilities.7
      ##
      ## These are the capabilities that Docker would add by default,
      ## except not, because we use cap_drop: ALL
      ## https://github.com/moby/moby/blob/2b9de2e24a9877843c1998366ac97959c12b45aa/oci/caps/defaults.go#L6-L19
      ## You can try commenting these out and test if you app works
      ## without them:
      - CHOWN
      - DAC_OVERRIDE
      - FSETID
      - FOWNER
      - MKNOD
      - NET_RAW
      - SETGID
      - SETUID
      - SETFCAP
      - SETPCAP
      - NET_BIND_SERVICE
      - SYS_CHROOT
      - KILL
      - AUDIT_WRITE
      ## The rest of these are PRIVILEGED capabilities:
      ## Unless you know you need one of these, you should delete
      ## them, or leave them commented out, they are for reference only!
      ## - AUDIT_CONTROL
      ## - AUDIT_READ
      ## - BLOCK_SUSPEND
      ## - DAC_READ_SEARCH
      ## - IPC_LOCK
      ## - IPC_OWNER
      ## - LEASE
      ## - LINUX_IMMUTABLE
      ## - MAC_ADMIN
      ## - MAC_OVERRIDE
      ## - NET_ADMIN
      ## - NET_BROADCAST
      ## - SYS_ADMIN
      ## - SYS_BOOT
      ## - SYSLOG
      ## - SYS_MODULE
      ## - SYS_NICE
      ## - SYS_PACCT
      ## - SYS_PTRACE
      ## - SYS_RAWIO
      ## - SYS_RESOURCE
      ## - SYS_TIME
      ## - SYS_TTY_CONFIG
      ## - WAKE_ALARM

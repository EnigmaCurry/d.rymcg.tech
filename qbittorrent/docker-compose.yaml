volumes:
  qbittorrent-config:
  qbittorrent_downloads:

services:
  qbittorrent-config:
    build:
      context: qbittorrent-config
      args:
        - DOCKER_CONTEXT=${QBITTORRENT_DOCKER_CONTEXT:-dist}
        - INSTANCE=${QBITTORRENT_INSTANCE:-default}
    environment:
      - QBITTORRENT_TRAEFIK_HOST
      - QBITTORRENT_VPN_CLIENT_INTERFACE_IPV4
      - QBITTORRENT_VPN_CLIENT_INTERFACE_IPV6
      - QBITTORRENT_RPC_BIND_ADDRESS
      - QBITTORRENT_BLOCKLIST_URL
      - QBITTORRENT_PEER_PORT
      - QBITTORRENT_OnTorrentAddedEnabled
      - QBITTORRENT_OnTorrentAddedProgram
      - QBITTORRENT_enabled
      - QBITTORRENT_program
      - QBITTORRENT_SessionAddExtensionToIncompleteFiles
      - QBITTORRENT_SessionAlternativeGlobalDLSpeedLimit
      - QBITTORRENT_SessionAlternativeGlobalUPSpeedLimit
      - QBITTORRENT_SessionDefaultSavePath
      - QBITTORRENT_SessionDisableAutoTMMByDefault
      - QBITTORRENT_SessionDisableAutoTMMTriggersCategorySavePathChanged
      - QBITTORRENT_SessionDisableAutoTMMTriggersDefaultSavePathChanged
      - QBITTORRENT_SessionExcludedFileNames
      - QBITTORRENT_SessionIgnoreSlowTorrentsForQueueing
      - QBITTORRENT_SessionMaxActiveDownloads
      - QBITTORRENT_SessionMaxActiveTorrents
      - QBITTORRENT_SessionMaxActiveUploads
      - QBITTORRENT_SessionTempPath
      - QBITTORRENT_SessionTempPathEnabled
      - QBITTORRENT_SessionQueueingSystemEnabled
      - QBITTORRENT_SessionTorrentExportDirectory
      - QBITTORRENT_AutoDeleteAddedTorrentFile
      - QBITTORRENT_DownloadsSavePath
      - QBITTORRENT_DownloadsTempPath
      - QBITTORRENT_SessionTorrentContentLayout
      - QBITTORRENT_GeneralLocale
      - QBITTORRENT_MailNotificationemail
      - QBITTORRENT_MailNotificationenabled
      - QBITTORRENT_MailNotificationpassword
      - QBITTORRENT_MailNotificationreq_auth
      - QBITTORRENT_MailNotificationreq_ssl
      - QBITTORRENT_MailNotificationsender
      - QBITTORRENT_MailNotificationsmtp_server
      - QBITTORRENT_MailNotificationusername
      - QBITTORRENT_Schedulerdays
      - QBITTORRENT_Schedulerend_time
      - QBITTORRENT_Schedulerstart_time
      - QBITTORRENT_SessionUseAlternativeGlobalSpeedLimit
      - QBITTORRENT_SessionBandwidthSchedulerEnabled
      - QBITTORRENT_SessionInterface
      - QBITTORRENT_SessionInterfaceName
      - QBITTORRENT_SessionInterfaceAddress
      - QBITTORRENT_MergeTrackersEnabled
      - QBITTORRENT_SessionSubcategoriesEnabled
      - QBITTORRENT_SessionUseCategoryPathsInManualMode
      - QBITTORRENT_SessionAnonymousModeEnabled
      - QBITTORRENT_SessionTorrentStopCondition
      - QBITTORRENT_WebUIUsername
      - QBITTORRENT_WebUIPassword_PBKDF2
      - QBITTORRENT_WebUILocalHostAuth
      - QBITTORRENT_WebUIAuthSubnetWhitelistEnabled
      - QBITTORRENT_WebUIAuthSubnetWhitelist
      - QBITTORRENT_WebUIClickjackingProtection
      - QBITTORRENT_WebUICSRFProtection
      - QBITTORRENT_GeneralStatusbarExternalIPDisplayed
    volumes:
      - qbittorrent-config:/config:z

  qbittorrent:
    build:
      context: ./qbittorrent
      args:
        QBITTORRENT_IMAGE: ${QBITTORRENT_IMAGE:-linuxserver/qbittorrent:latest}
    depends_on:
      - qbittorrent-config
    cap_add:
      - NET_ADMIN ## Dropped ASAP in app-router-bootstrap.sh entrypoint.
    environment:
      - WIREGUARD_INSTANCE=${QBITTORRENT_WIREGUARD_INSTANCE}
      - WIREGUARD_ROUTER_IPV4=${QBITTORRENT_WIREGUARD_ROUTER_IPV4}
      - WIREGUARD_ROUTER_IPV6=${QBITTORRENT_WIREGUARD_ROUTER_IPV6}
      - DOCKER_GATEWAY_PORTS=${QBITTORRENT_DOCKER_GATEWAY_PORTS}
      - PUID=${QBITTORRENT_UID}
      - PGID=${QBITTORRENT_GID}
      - TZ=${TIMEZONE}
      - WEBUI_PORT=8080
    volumes:
      - qbittorrent-config:/config
      - ${QBITTORRENT_DOWNLOAD_VOLUME:-qbittorrent_downloads}:/downloads:z
    restart: unless-stopped
    labels:
      - "backup-volume.stop-during-backup=true"      
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
